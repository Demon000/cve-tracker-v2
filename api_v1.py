from flask import Blueprint, jsonify, request
from pymongo.errors import DuplicateKeyError
from classes import *
from utils import *

api_v1 = Blueprint('api_v1', __name__, url_prefix='/api/v1')

@api_v1.route('/kernels', methods=['POST'])
def post_kernels():
    request_data = request.get_json()

    if not request_data:
        return json_response_error({
            'message': 'Request body cannot be empty.'
        }, 400)

    repo = request_data.get('repo')
    try:
        vendor, device = repo_to_vendor_device(repo)
    except ValueError as e:
        return json_response_error({
            'message': str(e)
        }, 400)

    deprecated = request_data.get('deprecated', False)

    try:
        kernel = Kernel(repo=repo, vendor=vendor, device=device,
                deprecated=deprecated).save()
    except NotUniqueError:
        return json_response_error({
            'message': 'Kernel already exists.'
        }, 400)

    return json_response_success({
        'message': 'Kernel has been successfully added.',
        'data': kernel
    }, 200)
