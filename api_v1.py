import traceback

from flask import Blueprint, jsonify, request
from classes import *
from utils import *
from errors import *

api_v1 = Blueprint('api_v1', __name__, url_prefix='/api/v1')

@api_v1.route('/status_descriptions', methods=['GET'])
def get_statuses():
    return json_response_success({
        'message': 'Status descriptions have been successfully retrieved.',
        'data': StatusDescriptions
    }, 200)

@api_v1.route('/kernel_versions', methods=['GET'])
def get_kernel_versions():
    return json_response_success({
        'message': 'Kernel versions have been successfully retrieved.',
        'data': KernelVersions
    }, 200)

@api_v1.route('/branch_names', methods=['GET'])
def get_branch_names():
    return json_response_success({
        'message': 'Branch names have been successfully retrieved.',
        'data': BranchNames
    }, 200)

@api_v1.route('/kernels', methods=['GET'])
def get_kernels():
    deprecated = request.args.get('deprecated')
    deprecated_values = map_deprecated_values(deprecated)

    kernels = Kernel.objects(deprecated__in=deprecated_values) \
            .order_by('repo')

    cves_count = Cve.objects.count()
    for kernel in kernels:
        kernel.set_percentages(cves_count)

    return json_response_success({
        'message': 'Kernels have been successfully retrieved.',
        'count': kernels.count(),
        'data': kernels
    }, 200)

@api_v1.route('/kernels/<repo>', methods=['GET'])
def get_kernel(repo):
    kernel = Kernel.objects.with_id(repo)
    if not kernel:
        raise DoesNotExistError('Kernel "{}" does not exist.'.format(repo))

    cves_count = Cve.objects.count()
    kernel.set_percentages(cves_count)

    return json_response_success({
        'message': 'Kernels have been successfully retrieved.',
        'data': kernel
    }, 200)

@api_v1.route('/kernels', methods=['POST'])
def post_kernels():
    request_data = request.get_json()

    if type(request_data) is not dict:
        raise InvalidTypeError('Request body is not an object.')

    kernel = Kernel.create(request_data).save()

    return json_response_success({
        'message': 'Kernel "{}" has been successfully added.' \
                .format(kernel.repo),
        'data': kernel
    }, 200)

@api_v1.route('/kernels/<repo>', methods=['PATCH'])
def patch_kernel(repo):
    request_data = request.get_json()

    if type(request_data) is not dict:
        return json_response_error({
            'message': 'Request body is not an object.'
        }, 400)

    kernel = Kernel.objects.with_id(repo)
    if not kernel:
        raise DoesNotExistError('Kernel "{}" does not exist.'.format(repo))

    kernel.patch(request_data).save()

    return json_response_success({
        'message': 'Kernel "{}" has been successfully updated.'.format(repo),
        'data': kernel
    }, 200)

@api_v1.route('/kernels/<repo>/<branch_name>/statuses',
        methods=['GET'])
def get_kernel_branch_statuses(repo, branch_name):
    kernel = Kernel.objects.with_id(repo)
    if not kernel:
        raise DoesNotExistError('Kernel "{}" does not exist.'.format(repo))

    kernel.validate_branch_with_name(branch_name)

    statuses = Status.objects(kernel=kernel, branch=branch_name) \
            .no_dereference().exclude('id')

    return json_response_success({
        'message': 'Statuses have been successfully retrieved.',
        'data': statuses
    }, 200)

@api_v1.route('/kernels/<repo>/<branch_name>/import_statuses',
        methods=['POST'])
def post_kernel_branch_import_statuses(repo, branch_name):
    request_data = request.get_json()

    print(repo, branch_name, request_data)

    if type(request_data) is not dict:
        raise InvalidTypeError('Request body is not an object.')

    to_kernel = Kernel.objects.with_id(repo)
    if not to_kernel:
        raise DoesNotExistError('Kernel "{}" does not exist.'.format(repo))

    to_branch = to_kernel.validate_branch_with_name(branch_name)

    from_repo = request_data.get('repo')
    from_kernel = Kernel.objects.with_id(from_repo)
    if not from_kernel:
        raise DoesNotExistError('Kernel "{}" does not exist.'.format(repo))

    from_branch_name = request_data.get('branch')
    from_branch = from_kernel.validate_branch_with_name(from_branch_name)

    override = request_data.get('override', False)

    to_statuses = to_branch.get_statuses(True)
    from_statuses = from_branch.get_statuses(True)
    statuses = []

    for cve in from_statuses:
        if override or to_statuses[cve] == StatusValues['unpatched']:
            status = to_branch.change_status(cve, from_statuses[cve])
            if status:
                statuses.append(status)

    for status in statuses:
        status.save()

    to_kernel.save()

    return json_response_success({
        'message': 'Stauses have been successfully imported.'
    }, 200)

@api_v1.route('/kernels/<repo>/<branch_name>/statuses',
        methods=['POST'])
def post_kernel_branch_statuses(repo, branch_name):
    request_data = request.get_json()

    if type(request_data) is not dict:
        raise InvalidTypeError('Request body is not an object.')

    kernel = Kernel.objects.with_id(repo)
    if not kernel:
        raise DoesNotExistError('Kernel "{}" does not exist.'.format(repo))

    branch = kernel.validate_branch_with_name(branch_name)

    cve_names = request_data.get('cves')
    if not cve_names:
        raise IsEmptyError('CVEs cannot be empty.')

    value = request_data.get('value')
    statuses = branch.change_statuses(cve_names, value)

    for status in statuses:
        status.save()

    kernel.save()

    cves_count = Cve.objects.count()
    branch.set_percentage(cves_count)

    return json_response_success({
        'message': 'Stauses have been successfully updated.',
        'percentage': branch.percentage
    }, 200)

@api_v1.route('/kernels/<repo>', methods=['DELETE'])
def delete_kernel(repo):
    kernel = Kernel.objects.with_id(repo)
    if not kernel:
        raise DoesNotExistError('Kernel "{}" does not exist.'.format(repo))

    kernel.delete()

    return json_response_success({
        'message': 'Kernel "{}" has been successfully deleted.'.format(repo),
        'data': kernel
    }, 200)

@api_v1.route('/cves', methods=['GET'])
def get_cves():
    cves = Cve.objects()

    return json_response_success({
        'message': 'CVEs have been successfully retrieved.',
        'count': cves.count(),
        'data': cves
    }, 200)

@api_v1.route('/cves', methods=['POST'])
def post_cves():
    request_data = request.get_json()

    if type(request_data) is not dict:
        raise InvalidTypeError('Request body is not an object.')

    cve = Cve.create(request_data).save()

    return json_response_success({
        'message': 'CVE "{}" has been successfully added.'.format(cve.name),
        'data': cve
    }, 200)

@api_v1.route('/cves/<name>', methods=['GET'])
def get_cve(name):
    cve = Cve.objects.with_id(name)
    if not cve:
        raise DoesNotExistError('CVE "{}" does not exist.'.format(name))

    return json_response_success({
        'message': 'CVE "{}" has been successfully retrieved.'.format(name),
        'data': cve
    }, 200)

@api_v1.route('/cves/<name>', methods=['PATCH'])
def patch_cve(name):
    request_data = request.get_json()

    if type(request_data) is not dict:
        raise InvalidTypeError('Request body is not an object.')

    cve = Cve.objects.with_id(name)
    if not cve:
        raise DoesNotExistError('CVE "{}" does not exist.'.format(name))

    cve.patch(request_data).save()

    return json_response_success({
        'message': 'CVE "{}" has been successfully updated.'.format(name),
        'data': cve
    }, 200)

@api_v1.route('/cves/<name>/statuses', methods=['GET'])
def get_cve_statuses(name):
    cve = Cve.objects.with_id(name)
    if not cve:
        raise DoesNotExistError('CVE "{}" does not exist.'.format(name))

    statuses = Status.objects(cve=cve)

    return json_response_success({
        'message': 'Statuses have been successfully retrieved.',
        'data': statuses
    }, 200)

@api_v1.route('/cves/<name>', methods=['DELETE'])
def delete_cve(name):
    cve = Cve.objects.with_id(name)
    if not cve:
        raise DoesNotExistError('CVE "{}" does not exist.'.format(name))

    cve.delete()

    return json_response_success({
        'message': 'CVE "{}" has been successfully deleted.'.format(name),
        'data': cve
    }, 200)

@api_v1.route('/patchsets/validate', methods=['POST'])
def validate_patchset():
    request_data = request.get_json()

    if type(request_data) is not dict:
        raise InvalidTypeError('Request body is not an object.')

    versions = request_data.get('versions')
    Patchset.validate_versions(versions)

    patches = request_data.get('patches')
    Patchset.validate_patches(patches)

    return json_response_success({
        'message': 'Patchset is valid'
    }, 200)

@api_v1.errorhandler(ValidationError)
@api_v1.errorhandler(DoesNotExistError)
@api_v1.errorhandler(AlreadyExistsError)
@api_v1.errorhandler(InvalidTypeError)
@api_v1.errorhandler(IsEmptyError)
def basic_error_handler(e):
    return json_response_error({
        'message': e.message
    }, e.status)

@api_v1.errorhandler(Exception)
def error_handler(e):
    stack = traceback.format_exc()
    print(stack)
    return json_response_error({
        'stack': stack,
        'message': 'An unknown error has occured, check logs.',
    }, 500)
