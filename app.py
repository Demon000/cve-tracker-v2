# !/usr/bin/env python

from flask import Flask, session
from flask_github import GitHub
from flask_mongoengine import MongoEngine

from api_v1 import create_api_v1_blueprint
from web import create_web_blueprint
from errors import *

import functools

app = Flask(__name__)
app.config.from_pyfile('app.cfg')
app.secret_key = app.config['SECRET_KEY']

app.db = MongoEngine(app)
app.github = GitHub(app)

def needs_login():
    return app.config['GITHUB_ORG'] is not None

def has_login():
    if not needs_login():
        return True

    return 'github_token' in session

def require_login(f):
    @functools.wraps(f)
    def wrapper(*args, **kwargs):
        if not has_login():
            raise LoginError('User is not logged in.')
        return f(*args, **kwargs)
    return wrapper

app.needs_login = needs_login
app.has_login = has_login
app.require_login = require_login

web = create_web_blueprint(app)
api_v1 = create_api_v1_blueprint(app)

app.register_blueprint(api_v1)
app.register_blueprint(web)
