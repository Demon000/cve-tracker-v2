(function() {
    function addKernel(kernel) {
        var url = '/api/v1/kernels';
        return apiFetcher('POST', url, kernel);
    }

    var addKernelDialog = ExtendedDialog({
        element: document.querySelector('#add-kernel-dialog'),
        trigger: document.querySelector('#add-kernel-dialog-trigger'),
        methods: {
            add: function(button) {
                var dialog = this;
                var repo = dialog.access.repo.value;
                var defaultBranch = dialog.access.defaultBranch.value;
                var branches =
                    dialog.access.branches.value
                    .split(' ')
                    .map(function(pair) {
                        var values = pair.split('=');
                        return {
                            name: values[0],
                            version: values[1]
                        };
                    });

                button.disabled = true;

                addKernel({
                    'repo': repo,
                    'branches': branches,
                    'default_branch': defaultBranch
                })
                .then(function(body) {
                    dialog.close();
                    location.reload();
                })
                .catch(function(body) {
                    informationView.show('error', body.message);
                    button.disabled = false;
                });
            }
        },
        access: {
            repo: '.repo',
            branches: '.branches',
            defaultBranch: '.default-branch'
        },
        actions: [{
            selector: '.actions .cancel',
            callback: 'close'
        }, {
            selector: '.actions .add',
            callback: 'add'
        }]
    });
})();
