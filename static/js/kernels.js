(function() {
    function parseResponse(response) {
        return response.value;
    }

    function addKernel(kernel) {
        var url = '/api/v1/kernels';
        return fetcher('POST', url, kernel)
            .then(parseResponse)
            .catch(parseResponse);
    }

    function handleAddKernel(button) {
        var dialog = this;
        var repo = dialog.access.repo.value;
        var defaultBranch = dialog.access.defaultBranch.value;
        var branches =
            dialog.access.branches.value
            .split(' ')
            .map(function(pair) {
                var values = pair.split('=');
                return {
                    name: values[0],
                    version: values[1]
                };
            });

        button.disabled = true;

        addKernel({
            'repo': repo,
            'branches': branches,
            'default_branch': defaultBranch
        })
        .then(function(body) {
            var type = body.success ? 'success' : 'error';
            informationView.show(type, body.message);
            if (body.success) {
                dialog.close();
                location.reload();
            }
            button.disabled = false;
        });
    }

    var addKernelDialog = ExtendedDialog({
        element: document.querySelector('#add-kernel-dialog'),
        trigger: document.querySelector('#add-kernel-dialog-trigger'),
        access: {
            repo: '.repo',
            branches: '.branches',
            defaultBranch: '.default-branch'
        },
        actions: [{
            selector: '.actions .cancel',
            callback: 'close'
        }, {
            selector: '.actions .add',
            callback: handleAddKernel
        }]
    });

    function deleteKernel(repo) {
        var url = '/api/v1/kernels/' + repo;
        return fetcher('DELETE', url)
            .then(parseResponse)
            .catch(parseResponse);
    }

    function handleDeleteKernel(button) {
        var dialog = this;
        var repo = dialog.access.repo.value;

        button.disabled = true;

        deleteKernel(repo)
        .then(function(body) {
            var type = body.success ? 'success' : 'error';
            informationView.show(type, body.message);
            if (body.success) {
                dialog.close();
                location.reload();
            }
            button.disabled = false;
        });
    }

    var deleteKernelDialog = ExtendedDialog({
        element: document.querySelector('#delete-kernel-dialog'),
        trigger: document.querySelector('#delete-kernel-dialog-trigger'),
        access: {
            repo: '.repo'
        },
        actions: [{
            selector: '.actions .cancel',
            callback: 'close'
        }, {
            selector: '.actions .delete',
            callback: handleDeleteKernel
        }]
    });
})();
