(function() {
    function ContextMenu(o) {
        var cm = this;
        var element = o.element;

        cm.openAt = function(x, y) {
            element.addEventListener('click', function(e) {
                e.stopPropagation();
            });

            document.body.addEventListener('click', function(e) {
                cm.close();
            });

            moveElement(element, x, y);

            var bounds = element.getBoundingClientRect();
            if (bounds.bottom > window.innerHeight) {
                y = y - bounds.height;
                moveElement(element, x, y);
            }

            element.classList.add('active');
        };

        cm.isOpen = function() {
            return element.classList.contains('active');
        };

        cm.close = function() {
            element.classList.remove('active');
        };

        cm.trigger = null;
        function handleTrigger(e) {
            cm.trigger = e.currentTarget;
            cm.openAt(e.pageX, e.pageY);
            e.stopPropagation();
        }

        cm.addTrigger = function(event, trigger) {
            trigger.addEventListener(event, handleTrigger);
        };

        cm.addTriggers = function(event, triggers) {
            triggers.forEach(cm.addTrigger.bind(null, event));
        };

        if (o.event && o.triggers) {
            var triggers = [].slice.call(o.triggers);
            cm.addTriggers(o.event, triggers);
        }
    }

    window.ContextMenu = ContextMenu;
})();
