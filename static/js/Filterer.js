(function() {
    function arrayIntersection(a, b) {
        var d = {};
        var results = [];
        for (var i = 0; i < b.length; i++) {
            d[b[i]] = true;
        }
        for (var j = 0; j < a.length; j++) {
            if (d[a[j]]) 
                results.push(a[j]);
        }
        return results;
    }

    function FilterElement(element, tags) {
        var fe = this;

        fe.setActive = function(value) {
            if (value) {
                element.classList.add('active');
            } else {
                element.classList.remove('active');
            }
        };

        fe.getActiveFor = function(targetTags) {
            var intersection = arrayIntersection(tags, targetTags);
            return intersection.length != 0;
        };

        fe.setActiveFor = function(targetTags) {
            fe.setActive(fe.getActiveFor(targetTags));
        };
    }

    function TrueNoop() { return true }

    function Filterer(options) {
        var f = this;

        var filterElements = options.elements.map(function(e) {
            return new FilterElement(e.element, e.tags);
        });
        var showAllIfNone = options.showAllIfNone;

        f.setActivesForFn = function(fn) {
            filterElements.forEach(function(filterElement) {
                filterElement.setActive(fn(filterElement));
            });
        };

        f.setActivesFor = function(activeTags) {
            if (activeTags.length == 0 && showAllIfNone) {
                f.setActivesForFn(TrueNoop);
            } else {
                f.setActivesForFn(function(filterElement) {
                    return filterElement.getActiveFor(activeTags);
                });
            }
        };
    }
    window.Filterer = Filterer;
})();