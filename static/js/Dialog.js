(function() {
    function isEscapeKey(e) {
        var isEscape = false;
        if (e.key == 'Escape' || e.key == 'Esc' || e.keyCode == 27) {
            isEscape = true;
        }
        return isEscape;
    }

    function moveElement(e, x, y) {
        if (x) {
            e.style.left = x + 'px';
        }
        if (y) {
            e.style.top = y + 'px';
        }
    }

    function resizeElement(e, width, height) {
        if (width) {
            e.style.width = width + 'px';
        }
        if (height) {
            e.style.height = height + 'px';
        }
    }

    function _draggableElement(element, target) {
        var clickOffsetX;
        var clickOffsetY;

        function dragHandler(e) {
            moveElement(element, e.clientX - clickOffsetX, e.clientY - clickOffsetY);
        }

        function dragEndHandler(e) {
            document.body.removeEventListener('mousemove', dragHandler);
            document.body.removeEventListener('mouseup', dragEndHandler);
        }

        function dragStart(e) {
            var boundingRect = element.getBoundingClientRect();
            clickOffsetX = e.clientX - boundingRect.left;
            clickOffsetY = e.clientY - boundingRect.top;
            document.body.addEventListener('mousemove', dragHandler);
            document.body.addEventListener('mouseup', dragEndHandler);
        }

        target.addEventListener('mousedown', dragStart);
    }

    function draggableElement(element, selector) {
        if (!selector) {
            return;
        }

        var target = document.querySelector(selector);
        if (!target) {
            return;
        }
        _draggableElement(element, target);
    }

    var dialogs = [];
    var focused;
    var focusedZIndex = 1000;

    function sortDialogs() {
        dialogs.sort(function(a, b) {
            var isOpen = b.isOpen() - a.isOpen();
            var elevationDelta = b.getElevation() - a.getElevation();
            return isOpen || elevationDelta;
        });
    }

    function Dialog(o) {
        var d = this;

        if (!o.element) {
            return;
        }

        if (!o.drag) {
            o.drag = '';
        }

        if (!o.actions) {
            o.actions = [];
        }

        if (!o.access) {
            o.access = {};
        }

        if (!o.afterResize) {
            o.afterResize = function() {};
        }

        if (!o.beforeOpen) {
            o.beforeOpen = function() {};
        }

        if (!o.afterOpen) {
            o.afterOpen = function() {};
        }

        if (!o.afterClose) {
            o.afterClose = function() {};
        }

        d.element = o.element;

        d.access = {};
        d.actions = {};

        var drag = o.drag;
        var afterResizeHook = o.afterResize;
        var beforeOpenHook = o.beforeOpen;
        var afterOpenHook = o.afterOpen;
        var afterCloseHook = o.afterClose;

        d.getElevation = function() {
            return parseInt(d.element.style.zIndex, 10);
        };

        d.setElevation = function(elevation) {
            d.element.style.zIndex = elevation;
        };

        d.isFocused = function() {
            return focused == d;
        };

        d.focus = function() {
            if (!d.isFocused()) {
                d.setElevation(focusedZIndex++);
                focused = d;
            }
        };

        d.isOpen = function() {
            return d.element.classList.contains('active');
        };

        d.close = function() {
            d.element.classList.remove('active');
            afterCloseHook();
        };

        d.open = function() {
            var shouldOpen = beforeOpenHook() != false;
            if (!shouldOpen) {
                return;
            }

            d.focus();
            d.element.classList.add('active');
            afterOpenHook();
        };

        d.measure = function() {
            if (!d.isOpen()) {
                d.element.classList.add('measure');
            }
            var measures = d.element.getBoundingClientRect();
            if (!d.isOpen()) {
                d.element.classList.remove('measure');
            }
            return measures;
        };

        d.move = moveElement.bind(d, d.element);

        d.center = function() {
            var measures = d.measure();
            var x = (window.innerWidth - measures.width) / 2;
            var y = (window.innerHeight - measures.height) / 2;
            d.move(x, y);
        };

        d.resize = function(width, height) {
            resizeElement(d.element, width, height);
            afterResizeHook(width, height);
        };

        d.limit = function() {
            var measures = d.measure();

            var width = measures.width;
            if (width > window.innerWidth) {
                width = window.innerWidth;
            }

            var height = measures.height;
            if (height > window.innerHeight) {
                height = window.innerHeight;
            }

            d.resize(width, height);
        };

        draggableElement(d.element, drag);
        d.element.addEventListener('mousedown', d.focus);
        window.addEventListener('resize', d.center);
        window.addEventListener('resize', d.limit);
        d.center();
        d.limit();

        if (o.trigger) {
            var target;
            var event;

            if (o.trigger instanceof Element) {
                target = o.trigger;
                event = 'click';
            } else {
                target = o.trigger.element;
                event = o.trigger.event;
            }

            target.addEventListener(event, d.open);
        }

        o.actions.forEach(function(a) {
            var target = d.element.querySelector(a.selector);
            if (!target) {
                return;
            }

            var callback;
            if (typeof a.callback == 'string') {
                callback = d[a.callback];
            } else {
                callback = function(e) {
                    a.callback.call(d, target, e);
                };
            }

            var event = a.event;
            if (!event) {
                event = 'click';
            }

            target.addEventListener(event, callback);

            if (a.id) {
                d.actions[a.id] = target;
            }
        });

        Object.keys(o.access).forEach(function(key) {
            d.access[key] = d.element.querySelector(o.access[key]);
        });

        dialogs.push(d);
    }

    document.addEventListener('keydown', function(e) {
        if (isEscapeKey(e)) {
            sortDialogs();
            if (dialogs.length) {
                dialogs[0].close();
            }
        }
    });

    window.Dialog = Dialog;
})();
