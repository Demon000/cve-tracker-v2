(function() {
    function isEscapeKey(e) {
        var isEscape = false;
        if (e.key == 'Escape' || e.key == 'Esc' || e.keyCode == 27) {
            isEscape = true;
        }
        return isEscape;
    }

    function _draggableElement(element, target, moveFn) {
        var clickOffsetX;
        var clickOffsetY;

        function dragHandler(e) {
            moveFn(e.clientX - clickOffsetX, e.clientY - clickOffsetY);
        }

        function dragEndHandler(e) {
            document.body.removeEventListener('mousemove', dragHandler);
            document.body.removeEventListener('mouseup', dragEndHandler);
        }

        function dragStart(e) {
            var boundingRect = element.getBoundingClientRect();
            clickOffsetX = e.clientX - boundingRect.left;
            clickOffsetY = e.clientY - boundingRect.top;
            document.body.addEventListener('mousemove', dragHandler);
            document.body.addEventListener('mouseup', dragEndHandler);
        }

        target.addEventListener('mousedown', dragStart);
    }

    function draggableElement(element, selector, moveFn) {
        if (!selector) {
            return;
        }

        var target = document.querySelector(selector);
        if (!target) {
            return;
        }

        if (!moveFn) {
            moveFn = moveElement.bind(null, target);
        }

        _draggableElement(element, target, moveFn);
    }

    function _resizableElement(element, target, resizeFn) {
        var clickOffsetX;
        var clickOffsetY;
        var boundingRect;

        function dragHandler(e) {
            var elementWidth = e.clientX - boundingRect.left + clickOffsetX;
            var elementHeight = e.clientY - boundingRect.top + clickOffsetY;
            resizeFn(elementWidth, elementHeight);
        }

        function dragEndHandler(e) {
            document.body.removeEventListener('mousemove', dragHandler);
            document.body.removeEventListener('mouseup', dragEndHandler);
        }

        function dragStart(e) {
            boundingRect = element.getBoundingClientRect();
            clickOffsetX = boundingRect.right - e.clientX;
            clickOffsetY = boundingRect.bottom - e.clientY;
            document.body.addEventListener('mousemove', dragHandler);
            document.body.addEventListener('mouseup', dragEndHandler);
        }

        target.addEventListener('mousedown', dragStart);
    }

    function resizableElement(element, selector, resizeFn) {
        if (!selector) {
            return;
        }

        var target = document.querySelector(selector);
        if (!target) {
            return;
        }

        if (!resizeFn) {
            resizeFn = resizeElement.bind(null, target);
        }

        _resizableElement(element, target, resizeFn);
    }

    var dialogs = [];
    var focused;
    var focusedZIndex = 1000;

    function sortDialogs() {
        dialogs.sort(function(a, b) {
            var isOpen = b.isOpen() - a.isOpen();
            var elevationDelta = b.getElevation() - a.getElevation();
            return isOpen || elevationDelta;
        });
    }

    function Dialog(o) {
        var d = this;

        if (!o.element) {
            return;
        }

        if (!o.drag) {
            o.drag = '';
        }

        if (!o.resize) {
            o.resize = '';
        }

        if (!o.actions) {
            o.actions = [];
        }

        if (!o.access) {
            o.access = {};
        }

        d.emitter = new EventEmitter();

        d.element = o.element;

        d.access = {};
        d.actions = {};

        var drag = o.drag;
        var resize = o.resize;

        d.getElevation = function() {
            return parseInt(d.element.style.zIndex, 10);
        };

        d.setElevation = function(elevation) {
            d.element.style.zIndex = elevation;
        };

        d.isFocused = function() {
            return focused == d;
        };

        d.focus = function() {
            if (!d.isFocused()) {
                d.setElevation(focusedZIndex++);
                focused = d;
            }
            d.emitter.emit('focused');
        };

        d.isOpen = function() {
            return d.element.classList.contains('active');
        };

        d.close = function() {
            d.element.classList.remove('active');
            d.emitter.emit('closed');
        };

        d.open = function() {
            d.focus();
            d.element.classList.add('active');
            d.emitter.emit('opened');
        };

        d.measuring = function(state) {
            if (!d.isOpen()) {
                if (state) {
                    d.element.classList.add('measure');
                } else {
                    d.element.classList.remove('measure');
                }
            }
        };

        d.measure = function() {
            d.measuring(true);
            var measures = d.element.getBoundingClientRect();
            d.measuring(false);
            return measures;
        };

        d.move = function(x, y) {
             moveElement(d.element, x, y);
             d.emitter.emit('moved');
        };

        d.center = function() {
            var measures = d.measure();
            var x = (window.innerWidth - measures.width) / 2;
            var y = (window.innerHeight - measures.height) / 2;
            d.move(x, y);
        };

        d.resize = function(width, height) {
            resizeElement(d.element, width, height);
            d.emitter.emit('resized');
        };

        d.limit = function() {
            var measures = d.measure();

            var width = measures.width;
            if (width > window.innerWidth) {
                width = window.innerWidth;
            }

            var height = measures.height;
            if (height > window.innerHeight) {
                height = window.innerHeight;
            }

            d.resize(width, height);
        };

        draggableElement(d.element, drag, d.move);
        resizableElement(d.element, resize, d.resize);
        d.element.addEventListener('mousedown', d.focus);
        window.addEventListener('resize', d.center);
        window.addEventListener('resize', d.limit);
        d.center();
        d.limit();

        if (o.trigger) {
            var target;
            var event;

            if (o.trigger instanceof Element) {
                target = o.trigger;
                event = 'click';
            } else {
                target = o.trigger.element;
                event = o.trigger.event;
            }

            target.addEventListener(event, d.open);
        }

        o.actions.forEach(function(a) {
            var target = d.element.querySelector(a.selector);
            if (!target) {
                return;
            }

            var callback;
            if (typeof a.callback == 'string') {
                callback = d[a.callback];
            } else {
                callback = a.callback.bind(d, target);
            }

            var event = a.event;
            if (!event) {
                event = 'click';
            }

            target.addEventListener(event, callback);

            if (a.id) {
                d.actions[a.id] = target;
            }
        });

        Object.keys(o.access).forEach(function(key) {
            d.access[key] = d.element.querySelector(o.access[key]);
        });

        dialogs.push(d);
    }

    document.addEventListener('keydown', function(e) {
        if (isEscapeKey(e)) {
            sortDialogs();
            if (dialogs.length) {
                dialogs[0].close();
            }
        }
    });

    window.Dialog = Dialog;
})();
