(function() {
    var percentage = document.querySelector('#percentage');
    var percentageBar = new Progress({
        element: percentage.querySelector('.progress-bar-inner'),
        field: percentage.querySelector('.progress-value'),
        value: percentage.getAttribute('data-value')
    });
    window.percentageBar = percentageBar;

    var patchsetsFormatDialog = new ExtendedDialog({
        element: document.querySelector('#patchsets-format-dialog'),
        triggers: document.querySelectorAll('.patchsets-format-dialog-triggers'),
        actions: [{
            selector: '.actions .cancel',
            callback: 'close'
        }]
    });

    function parseResponse(response) {
        return response.value;
    }

    function addCve(cve) {
        var url = '/api/v1/cves';
        return fetcher('POST', url, cve)
                .then(parseResponse)
                .catch(parseResponse);
    }

    function handleAddCve(button) {
        var dialog = this;
        var name = dialog.access.name.value;
        var notes = dialog.access.notes.value;
        var score = parseFloat(dialog.access.score.value);
        var tags = dialog.access.tags.value.split(' ');
        var patchsets =
            dialog.access.patchsets.value
            .split('\n\n')
            .map(function(group) {
                var lines = group.split('\n');
                var versions = lines[0].split(' ');
                var patches = lines.slice(1);
                return {
                    versions: versions,
                    patches: patches
                };
            });

        button.disabled = true;

        addCve({
            'name': name,
            'notes': notes,
            'score': score,
            'tags': tags,
            'patchsets': patchsets
        })
        .then(function(body) {
            var type = body.success ? 'success' : 'error';
            informationView.show(type, body.message);
            if (body.success) {
                dialog.close();
                location.reload();
            }
            button.disabled = false;
        });
    }

    var addCveDialog = new ExtendedDialog({
        element: document.querySelector('#add-cve-dialog'),
        trigger: document.querySelector('#add-cve-dialog-trigger'),
        access: {
            name: '.name',
            notes: '.notes',
            score: '.score',
            tags: '.tags',
            patchsets: '.patchsets'
        },
        actions: [{
            selector: '.actions .cancel',
            callback: 'close'
        }, {
            selector: '.actions .add',
            callback: handleAddCve
        }]
    });
})();
