(function() {
    var percentage = document.querySelector('#percentage');
    var percentageBar = new Progress({
        element: percentage.querySelector('.progress-bar-inner'),
        field: percentage.querySelector('.progress-value'),
        value: percentage.getAttribute('data-value')
    });
    window.percentageBar = percentageBar;

    function getScoreSeverity(score) {
        var severity = 'low';

        if (score >= 9) {
            severity = 'critical';
        } else if (score >= 7) {
            severity = 'high';
        } else if (score >= 4) {
            severity = 'medium';
        }

        return severity;
    }

    var cveSeverities = document.querySelectorAll('.cve .severity');
    _.each(cveSeverities, function(cveSeverity) {
        var score = cveSeverity.getAttribute('data-score');
        var severity = getScoreSeverity(score);
        cveSeverity.classList.add(severity);
    });

    var cveInfoPatchsetsList = new ListView({
        container: document.querySelector('#cve-info-dialog .patchsets'),
        template: document.querySelector('#patchset-template').innerHTML
    });

    var cveInfoDialog = new ExtendedDialog({
        element: document.querySelector('#cve-info-dialog'),
        methods: {
            set: function(cve) {
                var dialog = this;
                var severity = getScoreSeverity(cve.score);

                dialog.access.name.innerHTML = cve.name;
                dialog.access.score.innerHTML = cve.score;
                dialog.access.score.setAttribute('data-severity', severity);
                dialog.access.notes.value = cve.notes;
                dialog.access.tags.value = cve.tags.join(' ');
                dialog.access.compare.href = '/cves/' + cve.name;

                cveInfoPatchsetsList.setData(cve.patchsets);

                if (dialog.access.edit) {
                    dialog.access.edit.onclick = function() {
                        addCveDialog.openEdit(cve.name);
                    };
                }

            },
            open: function(name) {
                var dialog = this;

                apiV1.cve(name)
                .get()
                .then(function(body) {
                    dialog.set(body.data);
                    dialog._open();
                })
                .catch(function(body) {
                    informationView.show('error', body.message);
                });
            }
        },
        access: {
            name: '.name',
            score: '.score',
            notes: '.notes',
            tags: '.tags',
            compare: '.actions .compare',
            edit: '.actions .edit'
        },
        actions: [{
            selector: '.actions .cancel',
            callback: 'close'
        }]
    });

    var cveNames = document.querySelectorAll('.cve .name');
    _.each(cveNames, function(cveName) {
        var name = cveName.getAttribute('data-name');
        cveName.addEventListener('click', function() {
            cveInfoDialog.open(name);
        });
    });
    window.cveInfoDialog = cveInfoDialog;
})();
