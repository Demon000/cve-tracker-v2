(function() {
    function stringToElement(s) {
        var div = document.createElement('div');
        div.innerHTML = s;
        return div.children[0];
    }

    function ListView(o) {
        var lv = this;
        var container = o.container;
        var template = _.template(o.template);
        var list = [];

        lv.emitter = new EventEmitter();

        lv.getElements = function() {
            return list.map(function(data) {
                return data._element;
            });
        };

        function addAction(data, action) {
            var target = data._element.querySelector(action.selector);
            if (!target) {
                return;
            }

            action.callback = action.callback.bind(lv, target,
                    data, data._index, list);

            if (!action.event) {
                action.event = 'click';
            }

            data._element.addEventListener(action.event, action.callback);
        }

        lv.render = function(data) {
            var s = template(data);
            return stringToElement(s);
        };

        lv.remove = function(data) {
            container.removeChild(data._element);
            list.splice(data._index, 1);
            lv.emitter.emit('remove', data, data._index, list);
            return data;
        };

        lv.removeAt = function(index) {
            var data = list[index];
            return lv.remove(data);
        };

        lv.set = function(data, index) {
            var oldData = list[index];
            if (oldData) {
                var oldElement = oldData._element;
                delete oldData._element;

                if (_.isEqual(oldData, data)) {
                    oldData._element = oldElement;
                    return oldData;
                }
            }

            var element = lv.render(data);
            if (oldData) {
                container.replaceChild(element, oldElement);
            } else {
                container.appendChild(element);
            }

            data._element = element;
            data._index = index;
            if (o.actions) {
                o.actions.forEach(addAction.bind(null, data));
            }

            list.splice(index, 1, data);

            lv.emitter.emit('set', data, index, list);
            return data;
        };

        lv.add = function(data) {
            return lv.set(data, list.length);
        };

        lv.refresh = function() {
            list.forEach(lv.set);
            return lv.getElements();
        };

        lv.getData = function() {
            return list;
        };

        lv.setData = function(data) {
            data.forEach(lv.set);
            return lv.getElements();
        };

        if (o.data) {
            lv.setData(o.data);
        }
    }
    window.ListView = ListView;
})();