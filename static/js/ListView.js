(function() {
    function stringToElement(s) {
        var div = document.createElement('div');
        div.innerHTML = s;
        return div.children[0];
    }

    function ListView(o) {
        var lv = this;
        var container = o.container;
        var template = _.template(o.template);
        var list = [];

        lv.emitter = new EventEmitter();

        lv.getElements = function() {
            return list.map(function(data) {
                return data._element;
            });
        };

        lv.render = function(data) {
            var s = template(data);
            return stringToElement(s);
        };

        lv.removeAt = function(index) {
            var data = list[index];
            container.removeChild(data._element);
            list.splice(index, 1);
            lv.emitter.emit('remove', data, index, list);
            return data;
        };

        lv.remove = function(data) {
            var index = list.indexOf(data);
            return lv.removeAt(index);
        };

        lv.set = function(data, index) {
            var oldData = list[index];
            if (oldData) {
                var oldElement = oldData._element;
                delete oldData._element;

                if (_.isEqual(oldData, data)) {
                    oldData._element = oldElement;
                    return oldData;
                }
            }

            var element = lv.render(data);
            if (oldData) {
                container.replaceChild(element, oldElement);
            } else {
                container.appendChild(element);
            }
            data._element = element;
            list.splice(index, 1, data);
            lv.emitter.emit('set', data, index, list);
            return data;
        };

        lv.add = function(data) {
            return lv.set(data, list.length);
        };

        lv.refresh = function() {
            list.forEach(lv.set);
            return lv.getElements();
        };

        lv.getData = function() {
            return list;
        };

        lv.setData = function(data) {
            data.forEach(lv.set);
            return lv.getElements();
        };

        if (o.data) {
            lv.setData(o.data);
        }
    }
    window.ListView = ListView;
})();