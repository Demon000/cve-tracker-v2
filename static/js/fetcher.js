(function() {
    function toQueryString(query) {
        if (!query) {
            return '';
        }

        var parts = [];
        for (var key in query) {
            parts.push(key + '=' + encodeURIComponent(query[key]));
        }
        return '?' + parts.join('&');
    }

    function fetcher(method, url, data) {
        var options = {};

        options.headers = {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        };

        options.method = method;

        if (data) {
            if (method == 'GET') {
                url += toQueryString(data);
            } else {
                options.body = JSON.stringify(data);
            }
        }

        return fetch(url, options)
            .then(function (response) {
                return new Promise(function(resolve, reject) {
                    var callback = response.ok ? resolve : reject;
                    response
                    .json()
                    .then(function(value) {
                         response.value = value;
                         callback(response);
                    });
                });
            })
            .then(function (response) {
                return new Promise(function(resolve, reject) {
                    var callback = response.ok ? resolve : reject;
                    response
                    .text()
                    .then(function(raw) {
                        response.raw = raw;
                        callback(response);
                    });
                });
            });
    }
    window.fetcher = fetcher;

    function parseResponse(response) {
        return response.value;
    }
    window.parseResponse = parseResponse;

    function apiFetcher(method, url, data) {
        return fetcher(method, url, data)
            .then(parseResponse)
            .catch(parseResponse);
    }
    window.apiFetcher = apiFetcher;
})();
