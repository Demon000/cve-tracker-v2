(function() {
    function toQueryString(query) {
        if (!query) {
            return '';
        }

        var parts = [];
        for (var key in query) {
            parts.push(key + '=' + encodeURIComponent(query[key]));
        }
        return '?' + parts.join('&');
    }

    function fetcher(method, url, data) {
        var options = {};

        options.headers = {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        };

        options.method = method;

        if (data) {
            if (method == 'GET') {
                url += toQueryString(data);
            } else {
                options.body = JSON.stringify(data);
            }
        }

        return fetch(url, options)
            .then(function (response) {
                return response.json();
            }).then(function (body) {
                if (body.success) {
                    return body;
                } else {
                    throw body;
                }
            });
    }
    window.fetcher = fetcher;
})();
