(function() {
    function toQueryString(query) {
        if (!query) {
            return '';
        }

        var parts = [];
        for (var key in query) {
            parts.push(key + '=' + encodeURIComponent(query[key]));
        }
        return '?' + parts.join('&');
    }

    function fetcher(method, url, data) {
        var options = {};

        options.credentials = 'include';
        options.headers = {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        };

        options.method = method;

        if (data) {
            if (method == 'GET') {
                url += toQueryString(data);
            } else {
                options.body = JSON.stringify(data);
            }
        }

        return fetch(url, options)
            .then(function (response) {
                return new Promise(function(resolve, reject) {
                    var callback = response.ok ? resolve : reject;
                    response
                    .json()
                    .then(function(value) {
                         response.value = value;
                         callback(response);
                    });
                });
            });
    }
    window.fetcher = fetcher;

    function getValue(response) {
        var value = response.value;
        if (value.stack) {
            console.error(value.stack);
        }

        if (response.ok) {
            return value;
        } else {
            throw value;
        }
    }
    window.getValue = getValue;

    function apiFetcher(method, url, data) {
        return fetcher(method, url, data)
            .then(getValue)
            .catch(getValue);
    }
    window.apiFetcher = apiFetcher;
})();
