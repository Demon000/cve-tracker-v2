{% extends "base.html" %}
{% block title %}{{ kernel.vendor }}/{{ kernel.device }} - LineageOS CVE Tracker{% endblock %}
{% block earlyscripts %}
    <script type="text/javascript">
        var pageData = {
            repo: "{{ kernel.repo }}",
            branchName: "{{ active_branch.name }}"
        };
    </script>
    <script src="/static/js/ContextMenu.js" type="text/javascript"></script>
    <script src="/static/js/ListView.js" type="text/javascript"></script>
    <script src="/static/js/Progress.js" type="text/javascript"></script>
    <script src="/static/js/Selector.js" type="text/javascript"></script>
    <link href="/static/css/kernel.css" rel="stylesheet" type="text/css">
{% endblock %}
{% block content %}
    <script id="patchset-template" type="text/template">
    {% raw %}
    <div class="patchset">
        <label>Versions</label>
        <div class="versions">
            <% _.each(versions, function(version) { %>
                <span class="version"> <%= version %></span>
            <% }); %>
        </div>
        <label>Patches</label>
        <div class="patches">
            <% _.each(patches, function(patch) { %>
                <a href="<%= patch %>" class="patch" target="_blank"><%= patch %></a>
            <% }); %>
        </div>
        <div class="actions">
            <i class="edit mdi mdi-pencil"></i>
            <i class="delete mdi mdi-delete"></i>
        </div>
    </div>
    {% endraw %}
    </script>

    {% if has_login() %}
    <div id="status-choices-menu" class="context-menu">
        {% for value, description in status_descriptions.items() %}
            <div data-description="{{ description }}" data-value="{{ value }}">
                {{ description }}
            </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if has_login() %}
    <div id="edit-kernel-dialog" class="dialog">
        <div class="title">Edit kernel</div>
        <div class="content">
            <div class="input-group">
                <label>Deprecated</label>
                <div class="switch">
                    <input id="deprecated" type="checkbox">
                    <label for="deprecated"></label>
                </div>
            </div>
            <div class="input-group">
                <label>Branches</label>
                <input class="branches" type="text">
                <p class="note">
                    Must be a space-separated list of name=version pairs.<br>
                    {% include 'branch_names.html' %}<br>
                    {% include 'kernel_versions.html' %}
                </p>
            </div>
            <div class="input-group">
                <label>Default branch</label>
                <input class="default-branch" type="text">
            </div>
        </div>
        <div class="actions">
            <button class="cancel">CANCEL</button>
            <button class="save">SAVE</button>
        </div>
    </div>
    {% endif %}

    {% if has_login() %}
    <div id="import-statuses-dialog" class="dialog">
        <div class="title">Import statuses</div>
        <div class="content">
            <div class="input-group">
                <label>From repo</label>
                <input class="repo" placeholder="android_kernel_vendor_device" type="text">
            </div>
            <div class="input-group">
                <label>From branch</label>
                <input class="branch" placeholder="cm-14.1" type="text">
            </div>
            <div class="input-group">
                <label>Override all</label>
                <div class="switch">
                    <input id="override" type="checkbox">
                    <label for="override"></label>
                </div>
                <p class="note">
                    By default, the imported statuses will only override unpatched statuses.<br>
                    Enable to override all.
                </p>
            </div>
        </div>
        <div class="actions">
            <button class="cancel">CANCEL</button>
            <button class="import">IMPORT</button>
        </div>
    </div>
    {% endif %}

    {% if has_login() %}
    <div id="patchset-dialog" class="dialog">
        <div class="title">
            <span data-for-mode="add">Add Patchset</span>
            <span data-for-mode="edit">Edit Patchset</span>
        </div>
        <div class="content">
            <div class="input-group">
                <label>Versions</label>
                <input class="versions" placeholder="...">
                <p class="note">
                    Must be a space separated list of kernel versions.<br>
                    {% include 'kernel_versions.html' %}
                </p>
            </div>
            <div class="input-group">
                <label>Patches</label>
                <textarea class="patches" placeholder="..."></textarea>
                <span class="note">Must be a new line separated list of links to raw patches.</span>
            </div>
        </div>
        <div class="actions">
            <button class="cancel">CANCEL</button>
            <button class="add" data-for-mode="add">ADD</button>
            <button class="save" data-for-mode="edit">SAVE</button>
        </div>
    </div>
    {% endif %}

    {% if has_login() %}
    <div id="add-cve-dialog" class="dialog">
        <div class="title">
            <span data-for-mode="add">Add CVE</span>
            <span data-for-mode="edit">
                Edit <span class="title-name"></span>
            </span>
        </div>
        <div class="content">
            <div class="input-group" data-for-mode="add">
                <label>Name</label>
                <input class="name" placeholder="CVE-20YY-XXXX" type="text">
            </div>
            <div class="input-group" data-for-mode="edit">
                <label>Score</label>
                <input class="score" default="0" min="0" max="10" type="number">
                <span class="note">Must be a value between 0 and 10, inclusive.</span>
            </div>
            <div class="input-group">
                <label>Notes</label>
                <textarea class="notes" placeholder="..."></textarea>
            </div>
            <div class="input-group">
                <label>Tags</label>
                <input class="tags" placeholder="..." type="text">
                <span class="note">Must be a space separated list of words.</span>
            </div>
            <div class="input-group">
                <div class="patchsets"></div>
                <button id="add-cve-patchset-dialog-trigger">ADD PATCHSET</button>
            </div>
        </div>
        <div class="actions">
            <button class="cancel">CANCEL</button>
            <button class="add" data-for-mode="add">ADD</button>
            <button class="save" data-for-mode="edit">SAVE</button>
        </div>
    </div>
    {% endif %}

    <div id="cve-info-dialog" class="dialog">
        <div class="title">
            <div class="name">CVE-20YY-XXX</div>
            <div class="score">-1</div>
        </div>
        <div class="content">
            <div class="input-group">
                <label>Notes</label>
                <textarea class="notes" placeholder="No notes specified." disabled="true"></textarea>
            </div>
            <div class="input-group">
                <label>Tags</label>
                <input class="tags" placeholder="No tags specified." disabled="true" type="text">
            </div>
            <div class="input-group">
                <div class="patchsets"></div>
            </div>
        </div>
        <div class="actions">
            {% if has_login() %}
            <button class="edit">EDIT</button>
            {% endif %}

            <a class="compare"><button>COMPARE KERNELS</button></a>
            <button class="cancel">CANCEL</button>
        </div>
    </div>

    <div class="card container">
        <div class="header">
            <span class="title">
                {{ kernel.vendor }}/{{ kernel.device }}
                <a href="https://github.com/{{ sources_org }}/{{ kernel.repo }}"
                        target="_blank" title="View on GitHub">
                    <i class="mdi mdi-github-circle"></i>
                </a>
            </span>
            <div id="branches" class="selectable">
                {% for branch in kernel.branches %}
                    <a href="{{ branch.name }}"
                    {% if branch.name == active_branch.name %}
                        class="active"
                    {% endif %}
                    >
                        {{ branch.name }}
                    </a>
                {% endfor %}
            </div>
            <div id="percentage" class="progress-bar"
                    data-value="{{ active_branch.percentage }}">
                <div class="progress-bar-inner"></div>
                <div class="progress-value"></div>
            </div>
        </div>

        {% if has_login() %}
        <div class="actions">
            <button id="edit-kernel-dialog-trigger">EDIT KERNEL</button>
            <button id="import-statuses-dialog-trigger">IMPORT STATUSES</button>
            <button id="add-cve-dialog-trigger">ADD CVE</button>
        </div>
        {% endif %}

    </div>

    {% if has_login() %}
    <div id="tags-container" class="card container">
        <div id="tags-container" class="selectable">
            {% for tag in tags %}
                <span class="tag" data-value="{{ tag }}">
                    {{ tag }}
                </span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="card container">
        <div id="cves-container">
            {% for cve in cves %}
                <div class="cve active"
                {% if cve.tags %}
                    data-tags="{{ cve.tags | join(' ') }}"
                {% else %}
                    data-tags="none"
                {% endif %}
                >
                    <span class="severity" data-score="{{ cve.score }}"></span>
                    <span class="name" data-name="{{ cve.name }}">{{ cve.name }}</span>
                    <span class="status
                            {% if has_login() %}authenticated{% endif %}"
                            data-name="{{ cve.name }}" data-value="{{ statuses[cve.name] }}">
                        {{ status_descriptions[statuses[cve.name]] }}
                    </span>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}
{% block latescripts %}
    <script src="/static/js/kernel.js"></script>

    {% if has_login() %}
    <script src="/static/js/kernel-authenticated.js"></script>
    {% endif %}
{% endblock %}
